<div class="filter-form-container">
  <form [formGroup]="filterForm" aria-label="Formulaire de filtres de recherche">
  
    <!-- Section Type de Locale - MOVED TO TOP -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-title">
          <div class="icon-container">
            <img src="assets/icons/type_locale.png" alt="Type de locale" class="section-icon-img">
          </div>
          <h3>Type de Logement</h3>
        </div>
        
        <img src="assets/icons/down.png" 
             alt="Expand section" 
             class="section-chevron" 
             [class.rotated]="typeLocaleExpanded"
             (click)="toggleTypeLocaleExpanded()">
        <label class="toggle-switch" for="useTypeLocaleFilter">
          <input type="checkbox" formControlName="useTypeLocaleFilter" id="useTypeLocaleFilter">
          <span class="slider"></span>
        </label>
      </div>

      <div class="section-content" *ngIf="typeLocaleExpanded">
        <div class="checkbox-group">
          <div class="checkbox-options" *ngFor="let option of typeLocaleOptions">
            <label class="checkbox-item">
              <input type="checkbox" 
                     [value]="option.value" 
                     [checked]="selectedTypeLocales.includes(option.value)"
                     (change)="onTypeLocaleCheckboxChange($event, option.value)">
              <span class="checkbox-label">
                <span class="emoji-icon">{{ option.icon }}</span>
                {{ option.label }}
              </span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Section Prix -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-title">
          <div class="icon-container">
            <img src="assets/icons/house-plus.png" alt="Prix" class="section-icon-img">
          </div>
          <h3>Ventes passées</h3>
        </div>
        <div class="loading-spinner" *ngIf="priceLoading">
          <div class="spinner"></div>
        </div>
        <img src="assets/icons/down.png" 
             alt="Expand section" 
             class="section-chevron" 
             [class.rotated]="priceExpanded"
             (click)="togglePriceExpanded()">
        <label class="toggle-switch" for="usePriceFilter">
          <input type="checkbox" formControlName="usePriceFilter" id="usePriceFilter">
          <span class="slider"></span>
        </label>
      </div>
  
      <div class="section-content" *ngIf="priceExpanded">
        <div class="radio-group-inline">
          <label class="radio-item">
            <input type="radio" value="exact" formControlName="priceMode" [checked]="filterForm.get('priceMode')?.value === 'exact'">
            <span class="radio-label">Exact</span>
          </label>
          <label class="radio-item">
            <input type="radio" value="range" formControlName="priceMode" [checked]="filterForm.get('priceMode')?.value === 'range'">
            <span class="radio-label">Intervalle</span>
          </label>
        </div>
  
        <div class="price-exact" *ngIf="filterForm.get('priceMode')?.value === 'exact'">
          <div class="form-group">
            <label for="price">Montant (€)</label>
            <input type="number" id="price" formControlName="price" >
          </div>
        </div>
  
        <div class="price-interval" *ngIf="filterForm.get('priceMode')?.value === 'range'">
          <div class="input-row-compact">
            <div class="form-group">
              <label for="minPrice">Min (€)</label>
              <input type="number" id="minPrice" formControlName="minPrice">
            </div>
            <div class="form-group">
              <label for="maxPrice">Max (€)</label>
              <input type="number" id="maxPrice" formControlName="maxPrice">
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Section Surface -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-title">
          <div class="icon-container">
            <img src="assets/icons/m2-icon.png" alt="Taille du terrain" class="section-icon-img">
          </div>
          <h3>Taille du terrain</h3>
        </div>
        <div class="loading-spinner" *ngIf="surfaceLoading">
          <div class="spinner"></div>
        </div>
        <img src="assets/icons/down.png" 
             alt="Expand section" 
             class="section-chevron" 
             [class.rotated]="surfaceExpanded"
             (click)="toggleSurfaceExpanded()">
        <label class="toggle-switch" for="useSurfaceFilter">
          <input type="checkbox" formControlName="useSurfaceFilter" id="useSurfaceFilter">
          <span class="slider"></span>
        </label>
      </div>
  
      <div class="section-content" *ngIf="surfaceExpanded">
        <div class="radio-group-inline">
          <label class="radio-item">
            <input type="radio" value="exact" formControlName="surfaceMode" [checked]="filterForm.get('surfaceMode')?.value === 'exact'">
            <span class="radio-label">Exact</span>
          </label>
          <label class="radio-item">
            <input type="radio" value="range" formControlName="surfaceMode" [checked]="filterForm.get('surfaceMode')?.value === 'range'">
            <span class="radio-label">Intervalle</span>
          </label>
        </div>
  
        <div class="surface-exact" *ngIf="filterForm.get('surfaceMode')?.value === 'exact'">
          <div class="form-group">
            <label for="surface">Surface (m²)</label>
            <input type="number" id="surface" formControlName="surface">
          </div>
        </div>
  
        <div class="surface-interval" *ngIf="filterForm.get('surfaceMode')?.value === 'range'">
          <div class="input-row-compact">
            <div class="form-group">
              <label for="minSurface">Min (m²)</label>
              <input type="number" id="minSurface" formControlName="minSurface">
            </div>
            <div class="form-group">
              <label for="maxSurface">Max (m²)</label>
              <input type="number" id="maxSurface" formControlName="maxSurface">
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <!-- Section Classe Énergétique -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-title">
          <div class="icon-container">
            <img src="assets/icons/energy-class-icon.png" alt="Classe énergétique" class="section-icon-img">
          </div>
          <h3>Classe énergétique</h3>
        </div>
        <div class="loading-spinner" *ngIf="energyLoading">
          <div class="spinner"></div>
        </div>
        <img src="assets/icons/down.png" 
             alt="Expand section" 
             class="section-chevron" 
             [class.rotated]="energyExpanded"
             (click)="toggleEnergyExpanded()">
        <label class="toggle-switch" for="useEnergyFilter">
          <input type="checkbox" formControlName="useEnergyFilter" id="useEnergyFilter">
          <span class="slider"></span>
        </label>
      </div>
  
      <div class="section-content" *ngIf="energyExpanded">
        <div class="energy-ratings">
          <label class="energy-rating rating-a">
            <input type="checkbox" formControlName="energyClassA">
            <span class="rating-letter">A</span>
          </label>
          <label class="energy-rating rating-b">
            <input type="checkbox" formControlName="energyClassB">
            <span class="rating-letter">B</span>
          </label>
          <label class="energy-rating rating-c">
            <input type="checkbox" formControlName="energyClassC">
            <span class="rating-letter">C</span>
          </label>
          <label class="energy-rating rating-d">
            <input type="checkbox" formControlName="energyClassD">
            <span class="rating-letter">D</span>
          </label>
          <label class="energy-rating rating-e">
            <input type="checkbox" formControlName="energyClassE">
            <span class="rating-letter">E</span>
          </label>
          <label class="energy-rating rating-f">
            <input type="checkbox" formControlName="energyClassF">
            <span class="rating-letter">F</span>
          </label>
          <label class="energy-rating rating-g">
            <input type="checkbox" formControlName="energyClassG">
            <span class="rating-letter">G</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Section Consommation -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-title">
          <div class="icon-container">
            <img src="assets/icons/kwh-icon.png" alt="Consommation" class="section-icon-img">
          </div>
          <h3>Consommation</h3>
        </div>
        <div class="loading-spinner" *ngIf="consumptionLoading">
          <div class="spinner"></div>
        </div>
        <img src="assets/icons/down.png" 
             alt="Expand section" 
             class="section-chevron" 
             [class.rotated]="consumptionExpanded"
             (click)="toggleConsumptionExpanded()">
        <label class="toggle-switch" for="useConsumptionFilter">
          <input type="checkbox" formControlName="useConsumptionFilter" id="useConsumptionFilter">
          <span class="slider"></span>
        </label>
      </div>
  
      <div class="section-content" *ngIf="consumptionExpanded">
        <div class="radio-group-inline">
          <label class="radio-item">
            <input type="radio" value="exact" formControlName="consumptionMode" [checked]="filterForm.get('consumptionMode')?.value === 'exact'">
            <span class="radio-label">Exact</span>
          </label>
          <label class="radio-item">
            <input type="radio" value="range" formControlName="consumptionMode" [checked]="filterForm.get('consumptionMode')?.value === 'range'">
            <span class="radio-label">Intervalle</span>
          </label>
        </div>

        <div class="consumption-exact" *ngIf="filterForm.get('consumptionMode')?.value === 'exact'">
          <div class="form-group">
            <label for="exactConsumption">Consommation (kWh/m²/an)</label>
            <input type="number" id="exactConsumption" formControlName="exactConsumption" >
          </div>
        </div>

        <div class="consumption-interval" *ngIf="filterForm.get('consumptionMode')?.value === 'range'">
          <div class="input-row-compact">
            <div class="form-group">
              <label for="minConsumption">Min (kWh/m²/an)</label>
              <input type="number" id="minConsumption" formControlName="minConsumption">
            </div>
            <div class="form-group">
              <label for="maxConsumption">Max (kWh/m²/an)</label>
              <input type="number" id="maxConsumption" formControlName="maxConsumption">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section Date with Custom Date Picker -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-title">
          <div class="icon-container">
            <img src="assets/icons/clock-icon.png" alt="Période" class="section-icon-img">
          </div>
          <h3>Période</h3>
        </div>
        <div class="loading-spinner" *ngIf="dateLoading">
          <div class="spinner"></div>
        </div>
        <img src="assets/icons/down.png" 
             alt="Expand section" 
             class="section-chevron" 
             [class.rotated]="dateExpanded"
             (click)="toggleDateExpanded()">
        <label class="toggle-switch" for="useDateFilter">
          <input type="checkbox" formControlName="useDateFilter" id="useDateFilter">
          <span class="slider"></span>
        </label>
      </div>

      <div class="section-content" *ngIf="dateExpanded">
        <div class="radio-group-inline">
          <label class="radio-item">
            <input type="radio" value="exact" formControlName="dateMode" [checked]="filterForm.get('dateMode')?.value === 'exact'">
            <span class="radio-label">Exact</span>
          </label>
          <label class="radio-item">
            <input type="radio" value="range" formControlName="dateMode" [checked]="filterForm.get('dateMode')?.value === 'range'">
            <span class="radio-label">Intervalle</span>
          </label>
        </div>

        <div class="date-exact" *ngIf="filterForm.get('dateMode')?.value === 'exact'">
          <div class="form-group">
            <label for="exactDate">Date</label>
            <div class="date-field">
              <input
                type="text"
                placeholder="jj/mm/aaaa"
                [value]="exactDateFormattedDate"
                readonly
                (click)="openExactDatePicker()"
                class="custom-date-input"
              />

              <div class="picker" *ngIf="isExactDatePickerOpen">
                <!-- Year View -->
                <ng-container *ngIf="exactDateView === 'year'">
                  <div class="grid years">
                    <div
                      class="cell"
                      *ngFor="let y of years"
                      (click)="selectExactDateYear(y)"
                    >
                      {{ y }}
                    </div>
                  </div>
                </ng-container>

                <!-- Month View -->
                <ng-container *ngIf="exactDateView === 'month'">
                  <div class="picker-header">{{ exactDateSelectedYear }}</div>
                  <div class="grid months">
                    <div
                      class="cell"
                      *ngFor="let m of months; let i = index"
                      (click)="selectExactDateMonth(i)"
                    >
                      {{ m }}
                    </div>
                  </div>
                </ng-container>

                <!-- Day View -->
                <ng-container *ngIf="exactDateView === 'day'">
                  <div class="picker-header">
                    {{ exactDateSelectedMonth !== null ? months[exactDateSelectedMonth] : '' }}
                    {{ exactDateSelectedYear }}
                  </div>
                  <div class="grid days">
                    <div class="dow" *ngFor="let d of dows">{{ d }}</div>
                    <div class="empty" *ngFor="let e of [].constructor(exactDateFirstDayOfMonth)"></div>
                    <div
                      class="cell"
                      *ngFor="let d of exactDateDaysInMonth"
                      (click)="selectExactDateDay(d)"
                    >
                      {{ d }}
                    </div>
                  </div>
                </ng-container>
              </div>
            </div>
          </div>
        </div>

        <div class="date-interval" *ngIf="filterForm.get('dateMode')?.value === 'range'">
          <div class="input-row-compact">
            <div class="form-group">
              <label for="startDate">Début</label>
              <div class="date-field">
                <input
                  type="text"
                  placeholder="jj/mm/aaaa"
                  [value]="startDateFormattedDate"
                  readonly
                  (click)="openStartDatePicker()"
                  class="custom-date-input"
                />

                <div class="picker" *ngIf="isStartDatePickerOpen">
                  <!-- Year View -->
                  <ng-container *ngIf="startDateView === 'year'">
                    <div class="grid years">
                      <div
                        class="cell"
                        *ngFor="let y of years"
                        (click)="selectStartDateYear(y)"
                      >
                        {{ y }}
                      </div>
                    </div>
                  </ng-container>

                  <!-- Month View -->
                  <ng-container *ngIf="startDateView === 'month'">
                    <div class="picker-header">{{ startDateSelectedYear }}</div>
                    <div class="grid months">
                      <div
                        class="cell"
                        *ngFor="let m of months; let i = index"
                        (click)="selectStartDateMonth(i)"
                      >
                        {{ m }}
                      </div>
                    </div>
                  </ng-container>

                  <!-- Day View -->
                  <ng-container *ngIf="startDateView === 'day'">
                    <div class="picker-header">
                      {{ startDateSelectedMonth !== null ? months[startDateSelectedMonth] : '' }}
                      {{ startDateSelectedYear }}
                    </div>
                    <div class="grid days">
                      <div class="dow" *ngFor="let d of dows">{{ d }}</div>
                      <div class="empty" *ngFor="let e of [].constructor(startDateFirstDayOfMonth)"></div>
                      <div
                        class="cell"
                        *ngFor="let d of startDateDaysInMonth"
                        (click)="selectStartDateDay(d)"
                      >
                        {{ d }}
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="endDate">Fin</label>
              <div class="date-field">
                <input
                  type="text"
                  placeholder="jj/mm/aaaa"
                  [value]="endDateFormattedDate"
                  readonly
                  (click)="openEndDatePicker()"
                  class="custom-date-input"
                />

                <div class="picker" *ngIf="isEndDatePickerOpen">
                  <!-- Year View -->
                  <ng-container *ngIf="endDateView === 'year'">
                    <div class="grid years">
                      <div
                        class="cell"
                        *ngFor="let y of years"
                        (click)="selectEndDateYear(y)"
                      >
                        {{ y }}
                      </div>
                    </div>
                  </ng-container>

                  <!-- Month View -->
                  <ng-container *ngIf="endDateView === 'month'">
                    <div class="picker-header">{{ endDateSelectedYear }}</div>
                    <div class="grid months">
                      <div
                        class="cell"
                        *ngFor="let m of months; let i = index"
                        (click)="selectEndDateMonth(i)"
                      >
                        {{ m }}
                      </div>
                    </div>
                  </ng-container>

                  <!-- Day View -->
                  <ng-container *ngIf="endDateView === 'day'">
                    <div class="picker-header">
                      {{ endDateSelectedMonth !== null ? months[endDateSelectedMonth] : '' }}
                      {{ endDateSelectedYear }}
                    </div>
                    <div class="grid days">
                      <div class="dow" *ngFor="let d of dows">{{ d }}</div>
                      <div class="empty" *ngFor="let e of [].constructor(endDateFirstDayOfMonth)"></div>
                      <div
                        class="cell"
                        *ngFor="let d of endDateDaysInMonth"
                        (click)="selectEndDateDay(d)"
                      >
                        {{ d }}
                      </div>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>